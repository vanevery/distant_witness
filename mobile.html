<html>
	<head>
		<script src="peer.min.js"></script>		
		<script type="text/javascript" src="/socket.io/socket.io.js"></script>

		<script type="text/javascript">

			var socket = io.connect();
			
			socket.on('connect', function() {
				socket.emit('type','mobile');
				if (peer_id != null) {
					socket.emit('peerid',peer_id);
				}				
			});

			socket.on('chatmessage', function (data) {
				document.getElementById("messages").innerHTML = data + "<br />\n" + document.getElementById("messages").innerHTML;
			});

			socket.on('peerid', function(data) {
				makeCall(data);
			});
			
			function sendPanic() {
				socket.emit('panic',"");
			}
			
			function sendMessage(message) {
				socket.emit('chatmessage', message);
			};

			/* Get User Media */
			var my_stream = null;

			var peer_id = null;

			var peer;

			window.URL = window.URL || window.webkitURL || window.mozURL || window.msURL;
			navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia;
			if (navigator.getUserMedia) {
				navigator.getUserMedia({video: {width: 640, height: 360}, audio: true}, function(stream) {
					my_stream = stream;
					var videoElement = document.getElementById('myvideo');
					videoElement.src = window.URL.createObjectURL(stream) || stream;
					videoElement.play();

					peer = new Peer({host: 'liveweb.itp.io', port: 9000, path: '/'});

					peer.on('open', function(id) {
						peer_id = id;
						console.log(peer_id);
						
						if (socket != null) {						  
						  socket.emit('peerid', peer_id);
						}
					});		
					
					peer.on('error', function(error) {
						console.log(error);
					});

					peer.on('call', function(incoming_call) {
						console.log("Got a call!");
						incoming_call.answer(my_stream); 						
						incoming_call.on('stream', function(remoteStream) { 
							console.log("Got a call's stream") 
							var ovideoElement = document.createElement('video');
							ovideoElement.src = window.URL.createObjectURL(remoteStream) || remoteStream;
							ovideoElement.setAttribute("autoplay", "true");	
							ovideoElement.setAttribute("id", incoming_call.peer);
							ovideoElement.setAttribute("controls", "controls");	
							ovideoElement.play();
							document.body.appendChild(ovideoElement);
						});
						
						incoming_call.on('close', function() {
							var ovideoElement = document.getElementById(incoming_call.peer);
							ovideoElement.parentElement.removeChild(ovideoElement);
						});
						
						incoming_call.on('error', function(err) {
							console.log(err);
							var ovideoElement = document.getElementById(incoming_call.peer);
							if (ovideoElement != null) {
								ovideoElement.parentElement.removeChild(ovideoElement);
							}
						});
						
					});

				}, function(err) {
					console.log('Failed to get local stream' ,err);
				});
			}	

			function makeCall(peeridtocall) {
				var call = peer.call(peeridtocall,my_stream);
				call.on('stream', function(remoteStream) {  
					var ovideoElement = document.createElement('video');
					ovideoElement.src = window.URL.createObjectURL(remoteStream) || remoteStream;
					ovideoElement.setAttribute("autoplay", "true");	
					ovideoElement.setAttribute("id", call.peer);	
					ovideoElement.play();
					document.body.appendChild(ovideoElement);					
				});	
						
				call.on('close', function() {
					var ovideoElement = document.getElementById(call.peer);
					ovideoElement.parentElement.removeChild(ovideoElement);
				});
				
				call.on('error', function(err) {
					var ovideoElement = document.getElementById(call.peer);
					if (ovideoElement != null) {
						ovideoElement.parentElement.removeChild(ovideoElement);
					}
				});						
						
			}



			if (navigator.geolocation) {

				navigator.geolocation.watchPosition(successCallback, errorCallback, {});

				function successCallback(currentPosition) {
				
					//var lat = currentPosition.coords.latitude;
					//var lng = currentPosition.coords.longitude;
					
					socket.emit('location', {lat: currentPosition.coords.latitude, lng: currentPosition.coords.longitude});
 				}

				function errorCallback(e) {
					console.log(e);
				}

			} else {
				console.log("Geolocation Not Allowed");
			}

		</script>
	</head>
	<body>
		<video id="myvideo" width="320" height="180" muted autoplay></video>
		<div id="messages"></div>
		<div id="panel">
			<input type="button" value="OK" onclick="sendMessage('Ok');">
			<input type="button" value="HELP" onclick="sendPanic();">
		</div>
	</body>

</html>
